version: "3.3"
networks:
  gamutrf:
services:
  compass:
    restart: always
    image: iqtlabs/gamutrf-compass:latest
    networks:
      - gamutrf
    cap_add:
      - SYS_NICE
    devices:
      - "/dev/i2c-1:/dev/i2c-1"
    ports:
      - '8000:8000'
  mqtt:
    restart: always
    image: iqtlabs/gamutrf-mqtt:latest
    networks:
      - gamutrf
    ports:
      - '1883:1883'
  gamutrf:
    restart: always
    image: iqtlabs/gamutrf:latest
    depends_on:
      sigfinder:
        condition: service_started
    networks:
      - gamutrf
    ports:
      - '9001:9000'
    cap_add:
      - SYS_NICE
      - SYS_RAWIO
    devices:
      - /dev/bus/usb:/dev/bus/usb
    command:
      - --logaddr=sigfinder
      - --igain=30
      - '--freq-start=${FREQ_START}'
      - '--freq-end=${FREQ_END}'
    healthcheck:
      test: [CMD, "/root/scanhc.sh", "9000"]
      interval: 10s
      timeout: 10s
      retries: 3
  sigfinder:
    restart: always
    image: iqtlabs/gamutrf-sigfinder:latest
    networks:
      - gamutrf
    ports:
      - '80:80'
      - '9002:9000'
    volumes:
      - '${VOL_PREFIX}:/logs'
    command:
      - --logaddr=sigfinder
      - --log=/logs/scan.csv
      - '--freq-start=${FREQ_START}'
      - '--freq-end=${FREQ_END}'
  birdseye:
    restart: always
    image: iqtlabs/birdseye:latest
    network_mode: host
    environment:
      - "DISPLAY=:0"
    volumes:
      - '${VOL_PREFIX}:/BirdsEye/runs'
      - '/tmp/.X11-unix:/tmp/.X11-unix:rw'
    command:
      - sigscan.py
  prometheus:
    restart: always
    image: 'prom/prometheus:v2.36.1'
    user: 'root'
    networks:
      - gamutrf
    ports:
      - '9090:9090'
    volumes:
      - '${VOL_PREFIX}/opt/prometheus/:/prometheus'
      - './prometheus.yml:/etc/prometheus/prometheus.yml'
  grafana:
    restart: always
    image: 'grafana/grafana:8.5.5'
    user: 'root'
    networks:
      - gamutrf
    ports:
      - '3000:3000'
    volumes:
      - '${VOL_PREFIX}/opt/grafana:/var/lib/grafana'
      - '${VOL_PREFIX}/opt/grafana/provisioning:/etc/grafana/provisioning'
  watchtower:
    image: containrrr/watchtower:latest
    restart: always
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    environment:
      - "WATCHTOWER_POLL_INTERVAL=3600"
      - "WATCHTOWER_CLEANUP=true"
      - "WATCHTOWER_INCLUDE_RESTARTING=true"
      - "WATCHTOWER_INCLUDE_STOPPED=true"
      - "WATCHTOWER_REVIVE_STOPPED=true"
